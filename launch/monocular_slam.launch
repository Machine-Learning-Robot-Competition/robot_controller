<launch>
  <!-- Basic parameters -->
  <param name="use_sim_time" type="bool" value="True"/>
  <arg name="rtabmap_args" default="--delete_db_on_start"/>
  <arg name="localization" default="false"/>

  <!-- Static transform for base_footprint to camera_link -->
  <node pkg="tf" type="static_transform_publisher" name="base_to_camera_tf" args="x y z roll pitch yaw B1_tf/base_footprint B1_tf/camera_link 10" />

  <!-- Monocular SLAM Configuration for RTAB-Map -->
  <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap" output="screen" args="$(arg rtabmap_args)">
    <param name="frame_id" type="string" value="B1_tf/base_footprint"/>
    <param name="odom_frame_id" type="string" value="B1_tf/odom"/>
    <param name="wait_for_transform" type="bool" value="true"/>

    <!-- Set up for monocular SLAM (disables depth, RGB-D, and stereo subscriptions) -->
    <param name="subscribe_depth" type="bool" value="false"/>
    <param name="subscribe_rgbd" type="bool" value="false"/>
    <param name="subscribe_stereo" type="bool" value="false"/>
    <param name="subscribe_scan" type="bool" value="false"/>

    <!-- Remap camera topics to use RGB monocular data -->
    <remap from="rgb/image" to="/B1/rrbot/camera1/image_raw"/>
    <remap from="rgb/camera_info" to="/B1/rrbot/camera1/camera_info"/>

    <!-- Configure image transport and enable loop closure detection for monocular mode -->
    <param name="rgb/image_transport" type="string" value="raw"/>
    <param name="RGBD/ProximityBySpace" type="string" value="true"/> <!-- Enable local loop closure detection -->
    <param name="Mem/IncrementalMemory" type="bool" value="true"/> <!-- Allow incremental mapping -->
    <param name="Mem/InitWMWithAllNodes" type="bool" value="true"/>
    <param name="Vis/MinInliers" type="int" value="0"/> <!-- Lower threshold for loop closure if struggling with detection -->
  </node>

  <!-- Visualization Configuration for RTAB-Map -->
  <node pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmap_viz" output="screen">
    <param name="subscribe_depth" type="bool" value="false"/>
    <param name="frame_id" type="string" value="B1_tf/base_footprint"/>
    <param name="wait_for_transform" type="bool" value="true"/>

    <!-- Remap camera topics for visualization -->
    <remap from="rgb/image" to="/B1/rrbot/camera1/image_raw"/>
    <remap from="rgb/camera_info" to="/B1/rrbot/camera1/camera_info"/>
  </node>

  <!-- Optional: RVIZ for additional visualization (uncomment if needed) -->
  <!--
  <node pkg="rviz" type="rviz" name="rviz" args="-d $(find rtabmap_demos)/launch/config/demo_robot_mapping.rviz" output="screen"/>
  -->
</launch>
